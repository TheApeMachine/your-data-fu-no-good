var jt=Object.defineProperty;var Ue=e=>{throw TypeError(e)};var Ct=(e,t,n)=>t in e?jt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var m=(e,t,n)=>Ct(e,typeof t!="symbol"?t+"":t,n),Pe=(e,t,n)=>t.has(e)||Ue("Cannot "+n);var l=(e,t,n)=>(Pe(e,t,"read from private field"),n?n.call(e):t.get(e)),g=(e,t,n)=>t.has(e)?Ue("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,n),p=(e,t,n,r)=>(Pe(e,t,"write to private field"),r?r.call(e,n):t.set(e,n),n),x=(e,t,n)=>(Pe(e,t,"access private method"),n);var ke=(e,t,n,r)=>({set _(a){p(e,t,a,n)},get _(){return l(e,t,r)}});var ze=(e,t,n)=>(r,a)=>{let s=-1;return i(0);async function i(c){if(c<=s)throw new Error("next() called multiple times");s=c;let o,u=!1,d;if(e[c]?(d=e[c][0][0],r.req.routeIndex=c):d=c===e.length&&a||void 0,d)try{o=await d(r,()=>i(c+1))}catch(h){if(h instanceof Error&&t)r.error=h,o=await t(h,r),u=!0;else throw h}else r.finalized===!1&&n&&(o=await n(r));return o&&(r.finalized===!1||u)&&(r.res=o),r}},Nt=Symbol(),Tt=async(e,t=Object.create(null))=>{const{all:n=!1,dot:r=!1}=t,s=(e instanceof ut?e.raw.headers:e.headers).get("Content-Type");return s!=null&&s.startsWith("multipart/form-data")||s!=null&&s.startsWith("application/x-www-form-urlencoded")?_t(e,{all:n,dot:r}):{}};async function _t(e,t){const n=await e.formData();return n?At(n,t):{}}function At(e,t){const n=Object.create(null);return e.forEach((r,a)=>{t.all||a.endsWith("[]")?Dt(n,a,r):n[a]=r}),t.dot&&Object.entries(n).forEach(([r,a])=>{r.includes(".")&&($t(n,r,a),delete n[r])}),n}var Dt=(e,t,n)=>{e[t]!==void 0?Array.isArray(e[t])?e[t].push(n):e[t]=[e[t],n]:t.endsWith("[]")?e[t]=[n]:e[t]=n},$t=(e,t,n)=>{let r=e;const a=t.split(".");a.forEach((s,i)=>{i===a.length-1?r[s]=n:((!r[s]||typeof r[s]!="object"||Array.isArray(r[s])||r[s]instanceof File)&&(r[s]=Object.create(null)),r=r[s])})},at=e=>{const t=e.split("/");return t[0]===""&&t.shift(),t},Pt=e=>{const{groups:t,path:n}=Mt(e),r=at(n);return It(r,t)},Mt=e=>{const t=[];return e=e.replace(/\{[^}]+\}/g,(n,r)=>{const a=`@${r}`;return t.push([a,n]),a}),{groups:t,path:e}},It=(e,t)=>{for(let n=t.length-1;n>=0;n--){const[r]=t[n];for(let a=e.length-1;a>=0;a--)if(e[a].includes(r)){e[a]=e[a].replace(r,t[n][1]);break}}return e},Re={},Ht=(e,t)=>{if(e==="*")return"*";const n=e.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);if(n){const r=`${e}#${t}`;return Re[r]||(n[2]?Re[r]=t&&t[0]!==":"&&t[0]!=="*"?[r,n[1],new RegExp(`^${n[2]}(?=/${t})`)]:[e,n[1],new RegExp(`^${n[2]}$`)]:Re[r]=[e,n[1],!0]),Re[r]}return null},Le=(e,t)=>{try{return t(e)}catch{return e.replace(/(?:%[0-9A-Fa-f]{2})+/g,n=>{try{return t(n)}catch{return n}})}},Ft=e=>Le(e,decodeURI),it=e=>{const t=e.url,n=t.indexOf("/",t.indexOf(":")+4);let r=n;for(;r<t.length;r++){const a=t.charCodeAt(r);if(a===37){const s=t.indexOf("?",r),i=t.slice(n,s===-1?void 0:s);return Ft(i.includes("%25")?i.replace(/%25/g,"%2525"):i)}else if(a===63)break}return t.slice(n,r)},Lt=e=>{const t=it(e);return t.length>1&&t.at(-1)==="/"?t.slice(0,-1):t},re=(e,t,...n)=>(n.length&&(t=re(t,...n)),`${(e==null?void 0:e[0])==="/"?"":"/"}${e}${t==="/"?"":`${(e==null?void 0:e.at(-1))==="/"?"":"/"}${(t==null?void 0:t[0])==="/"?t.slice(1):t}`}`),ot=e=>{if(e.charCodeAt(e.length-1)!==63||!e.includes(":"))return null;const t=e.split("/"),n=[];let r="";return t.forEach(a=>{if(a!==""&&!/\:/.test(a))r+="/"+a;else if(/\:/.test(a))if(/\?/.test(a)){n.length===0&&r===""?n.push("/"):n.push(r);const s=a.replace("?","");r+="/"+s,n.push(r)}else r+="/"+a}),n.filter((a,s,i)=>i.indexOf(a)===s)},Me=e=>/[%+]/.test(e)?(e.indexOf("+")!==-1&&(e=e.replace(/\+/g," ")),e.indexOf("%")!==-1?Le(e,ct):e):e,lt=(e,t,n)=>{let r;if(!n&&t&&!/[%+]/.test(t)){let i=e.indexOf(`?${t}`,8);for(i===-1&&(i=e.indexOf(`&${t}`,8));i!==-1;){const c=e.charCodeAt(i+t.length+1);if(c===61){const o=i+t.length+2,u=e.indexOf("&",o);return Me(e.slice(o,u===-1?void 0:u))}else if(c==38||isNaN(c))return"";i=e.indexOf(`&${t}`,i+1)}if(r=/[%+]/.test(e),!r)return}const a={};r??(r=/[%+]/.test(e));let s=e.indexOf("?",8);for(;s!==-1;){const i=e.indexOf("&",s+1);let c=e.indexOf("=",s);c>i&&i!==-1&&(c=-1);let o=e.slice(s+1,c===-1?i===-1?void 0:i:c);if(r&&(o=Me(o)),s=i,o==="")continue;let u;c===-1?u="":(u=e.slice(c+1,i===-1?void 0:i),r&&(u=Me(u))),n?(a[o]&&Array.isArray(a[o])||(a[o]=[]),a[o].push(u)):a[o]??(a[o]=u)}return t?a[t]:a},qt=lt,Ut=(e,t)=>lt(e,t,!0),ct=decodeURIComponent,Ve=e=>Le(e,ct),ie,N,F,dt,ht,He,q,Ge,ut=(Ge=class{constructor(e,t="/",n=[[]]){g(this,F);m(this,"raw");g(this,ie);g(this,N);m(this,"routeIndex",0);m(this,"path");m(this,"bodyCache",{});g(this,q,e=>{const{bodyCache:t,raw:n}=this,r=t[e];if(r)return r;const a=Object.keys(t)[0];return a?t[a].then(s=>(a==="json"&&(s=JSON.stringify(s)),new Response(s)[e]())):t[e]=n[e]()});this.raw=e,this.path=t,p(this,N,n),p(this,ie,{})}param(e){return e?x(this,F,dt).call(this,e):x(this,F,ht).call(this)}query(e){return qt(this.url,e)}queries(e){return Ut(this.url,e)}header(e){if(e)return this.raw.headers.get(e)??void 0;const t={};return this.raw.headers.forEach((n,r)=>{t[r]=n}),t}async parseBody(e){var t;return(t=this.bodyCache).parsedBody??(t.parsedBody=await Tt(this,e))}json(){return l(this,q).call(this,"text").then(e=>JSON.parse(e))}text(){return l(this,q).call(this,"text")}arrayBuffer(){return l(this,q).call(this,"arrayBuffer")}blob(){return l(this,q).call(this,"blob")}formData(){return l(this,q).call(this,"formData")}addValidatedData(e,t){l(this,ie)[e]=t}valid(e){return l(this,ie)[e]}get url(){return this.raw.url}get method(){return this.raw.method}get[Nt](){return l(this,N)}get matchedRoutes(){return l(this,N)[0].map(([[,e]])=>e)}get routePath(){return l(this,N)[0].map(([[,e]])=>e)[this.routeIndex].path}},ie=new WeakMap,N=new WeakMap,F=new WeakSet,dt=function(e){const t=l(this,N)[0][this.routeIndex][1][e],n=x(this,F,He).call(this,t);return n&&/\%/.test(n)?Ve(n):n},ht=function(){const e={},t=Object.keys(l(this,N)[0][this.routeIndex][1]);for(const n of t){const r=x(this,F,He).call(this,l(this,N)[0][this.routeIndex][1][n]);r!==void 0&&(e[n]=/\%/.test(r)?Ve(r):r)}return e},He=function(e){return l(this,N)[1]?l(this,N)[1][e]:e},q=new WeakMap,Ge),kt={Stringify:1},ft=async(e,t,n,r,a)=>{typeof e=="object"&&!(e instanceof String)&&(e instanceof Promise||(e=e.toString()),e instanceof Promise&&(e=await e));const s=e.callbacks;return s!=null&&s.length?(a?a[0]+=e:a=[e],Promise.all(s.map(c=>c({phase:t,buffer:a,context:r}))).then(c=>Promise.all(c.filter(Boolean).map(o=>ft(o,t,!1,r,a))).then(()=>a[0]))):Promise.resolve(e)},zt="text/plain; charset=UTF-8",Ie=(e,t)=>({"Content-Type":e,...t}),ye,ve,P,oe,M,j,we,le,ce,Y,be,Ee,U,se,Xe,Vt=(Xe=class{constructor(e,t){g(this,U);g(this,ye);g(this,ve);m(this,"env",{});g(this,P);m(this,"finalized",!1);m(this,"error");g(this,oe);g(this,M);g(this,j);g(this,we);g(this,le);g(this,ce);g(this,Y);g(this,be);g(this,Ee);m(this,"render",(...e)=>(l(this,le)??p(this,le,t=>this.html(t)),l(this,le).call(this,...e)));m(this,"setLayout",e=>p(this,we,e));m(this,"getLayout",()=>l(this,we));m(this,"setRenderer",e=>{p(this,le,e)});m(this,"header",(e,t,n)=>{this.finalized&&p(this,j,new Response(l(this,j).body,l(this,j)));const r=l(this,j)?l(this,j).headers:l(this,Y)??p(this,Y,new Headers);t===void 0?r.delete(e):n!=null&&n.append?r.append(e,t):r.set(e,t)});m(this,"status",e=>{p(this,oe,e)});m(this,"set",(e,t)=>{l(this,P)??p(this,P,new Map),l(this,P).set(e,t)});m(this,"get",e=>l(this,P)?l(this,P).get(e):void 0);m(this,"newResponse",(...e)=>x(this,U,se).call(this,...e));m(this,"body",(e,t,n)=>x(this,U,se).call(this,e,t,n));m(this,"text",(e,t,n)=>!l(this,Y)&&!l(this,oe)&&!t&&!n&&!this.finalized?new Response(e):x(this,U,se).call(this,e,t,Ie(zt,n)));m(this,"json",(e,t,n)=>x(this,U,se).call(this,JSON.stringify(e),t,Ie("application/json",n)));m(this,"html",(e,t,n)=>{const r=a=>x(this,U,se).call(this,a,t,Ie("text/html; charset=UTF-8",n));return typeof e=="object"?ft(e,kt.Stringify,!1,{}).then(r):r(e)});m(this,"redirect",(e,t)=>{const n=String(e);return this.header("Location",/[^\x00-\xFF]/.test(n)?encodeURI(n):n),this.newResponse(null,t??302)});m(this,"notFound",()=>(l(this,ce)??p(this,ce,()=>new Response),l(this,ce).call(this,this)));p(this,ye,e),t&&(p(this,M,t.executionCtx),this.env=t.env,p(this,ce,t.notFoundHandler),p(this,Ee,t.path),p(this,be,t.matchResult))}get req(){return l(this,ve)??p(this,ve,new ut(l(this,ye),l(this,Ee),l(this,be))),l(this,ve)}get event(){if(l(this,M)&&"respondWith"in l(this,M))return l(this,M);throw Error("This context has no FetchEvent")}get executionCtx(){if(l(this,M))return l(this,M);throw Error("This context has no ExecutionContext")}get res(){return l(this,j)||p(this,j,new Response(null,{headers:l(this,Y)??p(this,Y,new Headers)}))}set res(e){if(l(this,j)&&e){e=new Response(e.body,e);for(const[t,n]of l(this,j).headers.entries())if(t!=="content-type")if(t==="set-cookie"){const r=l(this,j).headers.getSetCookie();e.headers.delete("set-cookie");for(const a of r)e.headers.append("set-cookie",a)}else e.headers.set(t,n)}p(this,j,e),this.finalized=!0}get var(){return l(this,P)?Object.fromEntries(l(this,P)):{}}},ye=new WeakMap,ve=new WeakMap,P=new WeakMap,oe=new WeakMap,M=new WeakMap,j=new WeakMap,we=new WeakMap,le=new WeakMap,ce=new WeakMap,Y=new WeakMap,be=new WeakMap,Ee=new WeakMap,U=new WeakSet,se=function(e,t,n){const r=l(this,j)?new Headers(l(this,j).headers):l(this,Y)??new Headers;if(typeof t=="object"&&"headers"in t){const s=t.headers instanceof Headers?t.headers:new Headers(t.headers);for(const[i,c]of s)i.toLowerCase()==="set-cookie"?r.append(i,c):r.set(i,c)}if(n)for(const[s,i]of Object.entries(n))if(typeof i=="string")r.set(s,i);else{r.delete(s);for(const c of i)r.append(s,c)}const a=typeof t=="number"?t:(t==null?void 0:t.status)??l(this,oe);return new Response(e,{status:a,headers:r})},Xe),b="ALL",Bt="all",Jt=["get","post","put","delete","options","patch"],pt="Can not add a route since the matcher is already built.",mt=class extends Error{},Wt="__COMPOSED_HANDLER",Kt=e=>e.text("404 Not Found",404),Be=(e,t)=>{if("getResponse"in e){const n=e.getResponse();return t.newResponse(n.body,n)}return console.error(e),t.text("Internal Server Error",500)},T,E,xt,_,W,Oe,je,Qe,gt=(Qe=class{constructor(t={}){g(this,E);m(this,"get");m(this,"post");m(this,"put");m(this,"delete");m(this,"options");m(this,"patch");m(this,"all");m(this,"on");m(this,"use");m(this,"router");m(this,"getPath");m(this,"_basePath","/");g(this,T,"/");m(this,"routes",[]);g(this,_,Kt);m(this,"errorHandler",Be);m(this,"onError",t=>(this.errorHandler=t,this));m(this,"notFound",t=>(p(this,_,t),this));m(this,"fetch",(t,...n)=>x(this,E,je).call(this,t,n[1],n[0],t.method));m(this,"request",(t,n,r,a)=>t instanceof Request?this.fetch(n?new Request(t,n):t,r,a):(t=t.toString(),this.fetch(new Request(/^https?:\/\//.test(t)?t:`http://localhost${re("/",t)}`,n),r,a)));m(this,"fire",()=>{addEventListener("fetch",t=>{t.respondWith(x(this,E,je).call(this,t.request,t,void 0,t.request.method))})});[...Jt,Bt].forEach(s=>{this[s]=(i,...c)=>(typeof i=="string"?p(this,T,i):x(this,E,W).call(this,s,l(this,T),i),c.forEach(o=>{x(this,E,W).call(this,s,l(this,T),o)}),this)}),this.on=(s,i,...c)=>{for(const o of[i].flat()){p(this,T,o);for(const u of[s].flat())c.map(d=>{x(this,E,W).call(this,u.toUpperCase(),l(this,T),d)})}return this},this.use=(s,...i)=>(typeof s=="string"?p(this,T,s):(p(this,T,"*"),i.unshift(s)),i.forEach(c=>{x(this,E,W).call(this,b,l(this,T),c)}),this);const{strict:r,...a}=t;Object.assign(this,a),this.getPath=r??!0?t.getPath??it:Lt}route(t,n){const r=this.basePath(t);return n.routes.map(a=>{var i;let s;n.errorHandler===Be?s=a.handler:(s=async(c,o)=>(await ze([],n.errorHandler)(c,()=>a.handler(c,o))).res,s[Wt]=a.handler),x(i=r,E,W).call(i,a.method,a.path,s)}),this}basePath(t){const n=x(this,E,xt).call(this);return n._basePath=re(this._basePath,t),n}mount(t,n,r){let a,s;r&&(typeof r=="function"?s=r:(s=r.optionHandler,r.replaceRequest===!1?a=o=>o:a=r.replaceRequest));const i=s?o=>{const u=s(o);return Array.isArray(u)?u:[u]}:o=>{let u;try{u=o.executionCtx}catch{}return[o.env,u]};a||(a=(()=>{const o=re(this._basePath,t),u=o==="/"?0:o.length;return d=>{const h=new URL(d.url);return h.pathname=h.pathname.slice(u)||"/",new Request(h,d)}})());const c=async(o,u)=>{const d=await n(a(o.req.raw),...i(o));if(d)return d;await u()};return x(this,E,W).call(this,b,re(t,"*"),c),this}},T=new WeakMap,E=new WeakSet,xt=function(){const t=new gt({router:this.router,getPath:this.getPath});return t.errorHandler=this.errorHandler,p(t,_,l(this,_)),t.routes=this.routes,t},_=new WeakMap,W=function(t,n,r){t=t.toUpperCase(),n=re(this._basePath,n);const a={basePath:this._basePath,path:n,method:t,handler:r};this.router.add(t,n,[r,a]),this.routes.push(a)},Oe=function(t,n){if(t instanceof Error)return this.errorHandler(t,n);throw t},je=function(t,n,r,a){if(a==="HEAD")return(async()=>new Response(null,await x(this,E,je).call(this,t,n,r,"GET")))();const s=this.getPath(t,{env:r}),i=this.router.match(a,s),c=new Vt(t,{path:s,matchResult:i,env:r,executionCtx:n,notFoundHandler:l(this,_)});if(i[0].length===1){let u;try{u=i[0][0][0][0](c,async()=>{c.res=await l(this,_).call(this,c)})}catch(d){return x(this,E,Oe).call(this,d,c)}return u instanceof Promise?u.then(d=>d||(c.finalized?c.res:l(this,_).call(this,c))).catch(d=>x(this,E,Oe).call(this,d,c)):u??l(this,_).call(this,c)}const o=ze(i[0],this.errorHandler,l(this,_));return(async()=>{try{const u=await o(c);if(!u.finalized)throw new Error("Context is not finalized. Did you forget to return a Response object or `await next()`?");return u.res}catch(u){return x(this,E,Oe).call(this,u,c)}})()},Qe),yt=[];function Yt(e,t){const n=this.buildAllMatchers(),r=(a,s)=>{const i=n[a]||n[b],c=i[2][s];if(c)return c;const o=s.match(i[0]);if(!o)return[[],yt];const u=o.indexOf("",1);return[i[1][u],o]};return this.match=r,r(e,t)}var Ne="[^/]+",me=".*",ge="(?:|/.*)",ae=Symbol(),Gt=new Set(".\\+*[^]$()");function Xt(e,t){return e.length===1?t.length===1?e<t?-1:1:-1:t.length===1||e===me||e===ge?1:t===me||t===ge?-1:e===Ne?1:t===Ne?-1:e.length===t.length?e<t?-1:1:t.length-e.length}var G,X,A,Ze,Fe=(Ze=class{constructor(){g(this,G);g(this,X);g(this,A,Object.create(null))}insert(t,n,r,a,s){if(t.length===0){if(l(this,G)!==void 0)throw ae;if(s)return;p(this,G,n);return}const[i,...c]=t,o=i==="*"?c.length===0?["","",me]:["","",Ne]:i==="/*"?["","",ge]:i.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);let u;if(o){const d=o[1];let h=o[2]||Ne;if(d&&o[2]&&(h===".*"||(h=h.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(h))))throw ae;if(u=l(this,A)[h],!u){if(Object.keys(l(this,A)).some(f=>f!==me&&f!==ge))throw ae;if(s)return;u=l(this,A)[h]=new Fe,d!==""&&p(u,X,a.varIndex++)}!s&&d!==""&&r.push([d,l(u,X)])}else if(u=l(this,A)[i],!u){if(Object.keys(l(this,A)).some(d=>d.length>1&&d!==me&&d!==ge))throw ae;if(s)return;u=l(this,A)[i]=new Fe}u.insert(c,n,r,a,s)}buildRegExpStr(){const n=Object.keys(l(this,A)).sort(Xt).map(r=>{const a=l(this,A)[r];return(typeof l(a,X)=="number"?`(${r})@${l(a,X)}`:Gt.has(r)?`\\${r}`:r)+a.buildRegExpStr()});return typeof l(this,G)=="number"&&n.unshift(`#${l(this,G)}`),n.length===0?"":n.length===1?n[0]:"(?:"+n.join("|")+")"}},G=new WeakMap,X=new WeakMap,A=new WeakMap,Ze),Te,Se,et,Qt=(et=class{constructor(){g(this,Te,{varIndex:0});g(this,Se,new Fe)}insert(e,t,n){const r=[],a=[];for(let i=0;;){let c=!1;if(e=e.replace(/\{[^}]+\}/g,o=>{const u=`@\\${i}`;return a[i]=[u,o],i++,c=!0,u}),!c)break}const s=e.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let i=a.length-1;i>=0;i--){const[c]=a[i];for(let o=s.length-1;o>=0;o--)if(s[o].indexOf(c)!==-1){s[o]=s[o].replace(c,a[i][1]);break}}return l(this,Se).insert(s,t,r,l(this,Te),n),r}buildRegExp(){let e=l(this,Se).buildRegExpStr();if(e==="")return[/^$/,[],[]];let t=0;const n=[],r=[];return e=e.replace(/#(\d+)|@(\d+)|\.\*\$/g,(a,s,i)=>s!==void 0?(n[++t]=Number(s),"$()"):(i!==void 0&&(r[Number(i)]=++t),"")),[new RegExp(`^${e}`),n,r]}},Te=new WeakMap,Se=new WeakMap,et),Zt=[/^$/,[],Object.create(null)],Ce=Object.create(null);function vt(e){return Ce[e]??(Ce[e]=new RegExp(e==="*"?"":`^${e.replace(/\/\*$|([.\\+*[^\]$()])/g,(t,n)=>n?`\\${n}`:"(?:|/.*)")}$`))}function en(){Ce=Object.create(null)}function tn(e){var u;const t=new Qt,n=[];if(e.length===0)return Zt;const r=e.map(d=>[!/\*|\/:/.test(d[0]),...d]).sort(([d,h],[f,v])=>d?1:f?-1:h.length-v.length),a=Object.create(null);for(let d=0,h=-1,f=r.length;d<f;d++){const[v,C,y]=r[d];v?a[C]=[y.map(([O])=>[O,Object.create(null)]),yt]:h++;let w;try{w=t.insert(C,h,v)}catch(O){throw O===ae?new mt(C):O}v||(n[h]=y.map(([O,te])=>{const he=Object.create(null);for(te-=1;te>=0;te--){const[D,De]=w[te];he[D]=De}return[O,he]}))}const[s,i,c]=t.buildRegExp();for(let d=0,h=n.length;d<h;d++)for(let f=0,v=n[d].length;f<v;f++){const C=(u=n[d][f])==null?void 0:u[1];if(!C)continue;const y=Object.keys(C);for(let w=0,O=y.length;w<O;w++)C[y[w]]=c[C[y[w]]]}const o=[];for(const d in i)o[d]=n[i[d]];return[s,o,a]}function ne(e,t){if(e){for(const n of Object.keys(e).sort((r,a)=>a.length-r.length))if(vt(n).test(t))return[...e[n]]}}var k,z,_e,wt,tt,nn=(tt=class{constructor(){g(this,_e);m(this,"name","RegExpRouter");g(this,k);g(this,z);m(this,"match",Yt);p(this,k,{[b]:Object.create(null)}),p(this,z,{[b]:Object.create(null)})}add(e,t,n){var c;const r=l(this,k),a=l(this,z);if(!r||!a)throw new Error(pt);r[e]||[r,a].forEach(o=>{o[e]=Object.create(null),Object.keys(o[b]).forEach(u=>{o[e][u]=[...o[b][u]]})}),t==="/*"&&(t="*");const s=(t.match(/\/:/g)||[]).length;if(/\*$/.test(t)){const o=vt(t);e===b?Object.keys(r).forEach(u=>{var d;(d=r[u])[t]||(d[t]=ne(r[u],t)||ne(r[b],t)||[])}):(c=r[e])[t]||(c[t]=ne(r[e],t)||ne(r[b],t)||[]),Object.keys(r).forEach(u=>{(e===b||e===u)&&Object.keys(r[u]).forEach(d=>{o.test(d)&&r[u][d].push([n,s])})}),Object.keys(a).forEach(u=>{(e===b||e===u)&&Object.keys(a[u]).forEach(d=>o.test(d)&&a[u][d].push([n,s]))});return}const i=ot(t)||[t];for(let o=0,u=i.length;o<u;o++){const d=i[o];Object.keys(a).forEach(h=>{var f;(e===b||e===h)&&((f=a[h])[d]||(f[d]=[...ne(r[h],d)||ne(r[b],d)||[]]),a[h][d].push([n,s-u+o+1]))})}}buildAllMatchers(){const e=Object.create(null);return Object.keys(l(this,z)).concat(Object.keys(l(this,k))).forEach(t=>{e[t]||(e[t]=x(this,_e,wt).call(this,t))}),p(this,k,p(this,z,void 0)),en(),e}},k=new WeakMap,z=new WeakMap,_e=new WeakSet,wt=function(e){const t=[];let n=e===b;return[l(this,k),l(this,z)].forEach(r=>{const a=r[e]?Object.keys(r[e]).map(s=>[s,r[e][s]]):[];a.length!==0?(n||(n=!0),t.push(...a)):e!==b&&t.push(...Object.keys(r[b]).map(s=>[s,r[b][s]]))}),n?tn(t):null},tt),V,I,nt,rn=(nt=class{constructor(e){m(this,"name","SmartRouter");g(this,V,[]);g(this,I,[]);p(this,V,e.routers)}add(e,t,n){if(!l(this,I))throw new Error(pt);l(this,I).push([e,t,n])}match(e,t){if(!l(this,I))throw new Error("Fatal error");const n=l(this,V),r=l(this,I),a=n.length;let s=0,i;for(;s<a;s++){const c=n[s];try{for(let o=0,u=r.length;o<u;o++)c.add(...r[o]);i=c.match(e,t)}catch(o){if(o instanceof mt)continue;throw o}this.match=c.match.bind(c),p(this,V,[c]),p(this,I,void 0);break}if(s===a)throw new Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,i}get activeRouter(){if(l(this,I)||l(this,V).length!==1)throw new Error("No active router has been determined yet.");return l(this,V)[0]}},V=new WeakMap,I=new WeakMap,nt),pe=Object.create(null),B,R,Q,ue,S,H,K,rt,bt=(rt=class{constructor(e,t,n){g(this,H);g(this,B);g(this,R);g(this,Q);g(this,ue,0);g(this,S,pe);if(p(this,R,n||Object.create(null)),p(this,B,[]),e&&t){const r=Object.create(null);r[e]={handler:t,possibleKeys:[],score:0},p(this,B,[r])}p(this,Q,[])}insert(e,t,n){p(this,ue,++ke(this,ue)._);let r=this;const a=Pt(t),s=[];for(let i=0,c=a.length;i<c;i++){const o=a[i],u=a[i+1],d=Ht(o,u),h=Array.isArray(d)?d[0]:o;if(h in l(r,R)){r=l(r,R)[h],d&&s.push(d[1]);continue}l(r,R)[h]=new bt,d&&(l(r,Q).push(d),s.push(d[1])),r=l(r,R)[h]}return l(r,B).push({[e]:{handler:n,possibleKeys:s.filter((i,c,o)=>o.indexOf(i)===c),score:l(this,ue)}}),r}search(e,t){var c;const n=[];p(this,S,pe);let a=[this];const s=at(t),i=[];for(let o=0,u=s.length;o<u;o++){const d=s[o],h=o===u-1,f=[];for(let v=0,C=a.length;v<C;v++){const y=a[v],w=l(y,R)[d];w&&(p(w,S,l(y,S)),h?(l(w,R)["*"]&&n.push(...x(this,H,K).call(this,l(w,R)["*"],e,l(y,S))),n.push(...x(this,H,K).call(this,w,e,l(y,S)))):f.push(w));for(let O=0,te=l(y,Q).length;O<te;O++){const he=l(y,Q)[O],D=l(y,S)===pe?{}:{...l(y,S)};if(he==="*"){const L=l(y,R)["*"];L&&(n.push(...x(this,H,K).call(this,L,e,l(y,S))),p(L,S,D),f.push(L));continue}const[De,qe,fe]=he;if(!d&&!(fe instanceof RegExp))continue;const $=l(y,R)[De],Ot=s.slice(o).join("/");if(fe instanceof RegExp){const L=fe.exec(Ot);if(L){if(D[qe]=L[0],n.push(...x(this,H,K).call(this,$,e,l(y,S),D)),Object.keys(l($,R)).length){p($,S,D);const $e=((c=L[0].match(/\//))==null?void 0:c.length)??0;(i[$e]||(i[$e]=[])).push($)}continue}}(fe===!0||fe.test(d))&&(D[qe]=d,h?(n.push(...x(this,H,K).call(this,$,e,D,l(y,S))),l($,R)["*"]&&n.push(...x(this,H,K).call(this,l($,R)["*"],e,D,l(y,S)))):(p($,S,D),f.push($)))}}a=f.concat(i.shift()??[])}return n.length>1&&n.sort((o,u)=>o.score-u.score),[n.map(({handler:o,params:u})=>[o,u])]}},B=new WeakMap,R=new WeakMap,Q=new WeakMap,ue=new WeakMap,S=new WeakMap,H=new WeakSet,K=function(e,t,n,r){const a=[];for(let s=0,i=l(e,B).length;s<i;s++){const c=l(e,B)[s],o=c[t]||c[b],u={};if(o!==void 0&&(o.params=Object.create(null),a.push(o),n!==pe||r&&r!==pe))for(let d=0,h=o.possibleKeys.length;d<h;d++){const f=o.possibleKeys[d],v=u[o.score];o.params[f]=r!=null&&r[f]&&!v?r[f]:n[f]??(r==null?void 0:r[f]),u[o.score]=!0}}return a},rt),Z,st,sn=(st=class{constructor(){m(this,"name","TrieRouter");g(this,Z);p(this,Z,new bt)}add(e,t,n){const r=ot(t);if(r){for(let a=0,s=r.length;a<s;a++)l(this,Z).insert(e,r[a],n);return}l(this,Z).insert(e,t,n)}match(e,t){return l(this,Z).search(e,t)}},Z=new WeakMap,st),Ae=class extends gt{constructor(e={}){super(e),this.router=e.router??new rn({routers:[new nn,new sn]})}},an=e=>{const n={...{origin:"*",allowMethods:["GET","HEAD","PUT","POST","DELETE","PATCH"],allowHeaders:[],exposeHeaders:[]},...e},r=(s=>typeof s=="string"?s==="*"?()=>s:i=>s===i?i:null:typeof s=="function"?s:i=>s.includes(i)?i:null)(n.origin),a=(s=>typeof s=="function"?s:Array.isArray(s)?()=>s:()=>[])(n.allowMethods);return async function(i,c){var d;function o(h,f){i.res.headers.set(h,f)}const u=await r(i.req.header("origin")||"",i);if(u&&o("Access-Control-Allow-Origin",u),n.origin!=="*"){const h=i.req.header("Vary");h?o("Vary",h):o("Vary","Origin")}if(n.credentials&&o("Access-Control-Allow-Credentials","true"),(d=n.exposeHeaders)!=null&&d.length&&o("Access-Control-Expose-Headers",n.exposeHeaders.join(",")),i.req.method==="OPTIONS"){n.maxAge!=null&&o("Access-Control-Max-Age",n.maxAge.toString());const h=await a(i.req.header("origin")||"",i);h.length&&o("Access-Control-Allow-Methods",h.join(","));let f=n.allowHeaders;if(!(f!=null&&f.length)){const v=i.req.header("Access-Control-Request-Headers");v&&(f=v.split(/\s*,\s*/))}return f!=null&&f.length&&(o("Access-Control-Allow-Headers",f.join(",")),i.res.headers.append("Vary","Access-Control-Request-Headers")),i.res.headers.delete("Content-Length"),i.res.headers.delete("Content-Type"),new Response(null,{headers:i.res.headers,status:204,statusText:"No Content"})}await c()}},on=/^\s*(?:text\/(?!event-stream(?:[;\s]|$))[^;\s]+|application\/(?:javascript|json|xml|xml-dtd|ecmascript|dart|postscript|rtf|tar|toml|vnd\.dart|vnd\.ms-fontobject|vnd\.ms-opentype|wasm|x-httpd-php|x-javascript|x-ns-proxy-autoconfig|x-sh|x-tar|x-virtualbox-hdd|x-virtualbox-ova|x-virtualbox-ovf|x-virtualbox-vbox|x-virtualbox-vdi|x-virtualbox-vhd|x-virtualbox-vmdk|x-www-form-urlencoded)|font\/(?:otf|ttf)|image\/(?:bmp|vnd\.adobe\.photoshop|vnd\.microsoft\.icon|vnd\.ms-dds|x-icon|x-ms-bmp)|message\/rfc822|model\/gltf-binary|x-shader\/x-fragment|x-shader\/x-vertex|[^;\s]+?\+(?:json|text|xml|yaml))(?:[;\s]|$)/i,Je=(e,t=cn)=>{const n=/\.([a-zA-Z0-9]+?)$/,r=e.match(n);if(!r)return;let a=t[r[1]];return a&&a.startsWith("text")&&(a+="; charset=utf-8"),a},ln={aac:"audio/aac",avi:"video/x-msvideo",avif:"image/avif",av1:"video/av1",bin:"application/octet-stream",bmp:"image/bmp",css:"text/css",csv:"text/csv",eot:"application/vnd.ms-fontobject",epub:"application/epub+zip",gif:"image/gif",gz:"application/gzip",htm:"text/html",html:"text/html",ico:"image/x-icon",ics:"text/calendar",jpeg:"image/jpeg",jpg:"image/jpeg",js:"text/javascript",json:"application/json",jsonld:"application/ld+json",map:"application/json",mid:"audio/x-midi",midi:"audio/x-midi",mjs:"text/javascript",mp3:"audio/mpeg",mp4:"video/mp4",mpeg:"video/mpeg",oga:"audio/ogg",ogv:"video/ogg",ogx:"application/ogg",opus:"audio/opus",otf:"font/otf",pdf:"application/pdf",png:"image/png",rtf:"application/rtf",svg:"image/svg+xml",tif:"image/tiff",tiff:"image/tiff",ts:"video/mp2t",ttf:"font/ttf",txt:"text/plain",wasm:"application/wasm",webm:"video/webm",weba:"audio/webm",webmanifest:"application/manifest+json",webp:"image/webp",woff:"font/woff",woff2:"font/woff2",xhtml:"application/xhtml+xml",xml:"application/xml",zip:"application/zip","3gp":"video/3gpp","3g2":"video/3gpp2",gltf:"model/gltf+json",glb:"model/gltf-binary"},cn=ln,un=(...e)=>{let t=e.filter(a=>a!=="").join("/");t=t.replace(new RegExp("(?<=\\/)\\/+","g"),"");const n=t.split("/"),r=[];for(const a of n)a===".."&&r.length>0&&r.at(-1)!==".."?r.pop():a!=="."&&r.push(a);return r.join("/")||"."},Et={br:".br",zstd:".zst",gzip:".gz"},dn=Object.keys(Et),hn="index.html",fn=e=>{const t=e.root??"./",n=e.path,r=e.join??un;return async(a,s)=>{var d,h,f,v;if(a.finalized)return s();let i;if(e.path)i=e.path;else try{if(i=decodeURIComponent(a.req.path),/(?:^|[\/\\])\.\.(?:$|[\/\\])/.test(i))throw new Error}catch{return await((d=e.onNotFound)==null?void 0:d.call(e,a.req.path,a)),s()}let c=r(t,!n&&e.rewriteRequestPath?e.rewriteRequestPath(i):i);e.isDir&&await e.isDir(c)&&(c=r(c,hn));const o=e.getContent;let u=await o(c,a);if(u instanceof Response)return a.newResponse(u.body,u);if(u){const C=e.mimes&&Je(c,e.mimes)||Je(c);if(a.header("Content-Type",C||"application/octet-stream"),e.precompressed&&(!C||on.test(C))){const y=new Set((h=a.req.header("Accept-Encoding"))==null?void 0:h.split(",").map(w=>w.trim()));for(const w of dn){if(!y.has(w))continue;const O=await o(c+Et[w],a);if(O){u=O,a.header("Content-Encoding",w),a.header("Vary","Accept-Encoding",{append:!0});break}}}return await((f=e.onFound)==null?void 0:f.call(e,c,a)),a.body(u)}await((v=e.onNotFound)==null?void 0:v.call(e,c,a)),await s()}},pn=async(e,t)=>{let n;t&&t.manifest?typeof t.manifest=="string"?n=JSON.parse(t.manifest):n=t.manifest:typeof __STATIC_CONTENT_MANIFEST=="string"?n=JSON.parse(__STATIC_CONTENT_MANIFEST):n=__STATIC_CONTENT_MANIFEST;let r;t&&t.namespace?r=t.namespace:r=__STATIC_CONTENT;const a=n[e]||e;if(!a)return null;const s=await r.get(a,{type:"stream"});return s||null},mn=e=>async function(n,r){return fn({...e,getContent:async s=>pn(s,{manifest:e.manifest,namespace:e.namespace?e.namespace:n.env?n.env.__STATIC_CONTENT:void 0})})(n,r)},gn=e=>mn(e);function xn(e){const t=e.trim().split(`
`);if(t.length===0)throw new Error("Empty CSV file");const n=We(t[0]),r=[];for(let a=1;a<t.length;a++){if(!t[a].trim())continue;const s=We(t[a]);s.length!==n.length&&console.warn(`Row ${a} has ${s.length} columns, expected ${n.length}`);const i={};n.forEach((c,o)=>{i[c]=s[o]!==void 0?s[o]:null}),r.push(i)}return r}function We(e){const t=[];let n="",r=!1;for(let a=0;a<e.length;a++){const s=e[a],i=e[a+1];s==='"'?r&&i==='"'?(n+='"',a++):r=!r:s===","&&!r?(t.push(n.trim()),n=""):n+=s}return t.push(n.trim()),t}function yn(e){if(e.length===0)return{};const t=Object.keys(e[0]),n={};for(const r of t){const a=e.slice(0,Math.min(100,e.length)).map(s=>s[r]);n[r]=vn(a)}return n}function vn(e){const t=e.filter(s=>s!=null&&s!=="");return t.length===0?"string":t.filter(s=>!isNaN(Number(s))).length===t.length?"number":t.filter(s=>!isNaN(Date.parse(s))).length===t.length?"date":t.filter(s=>s.toString().toLowerCase()==="true"||s.toString().toLowerCase()==="false").length===t.length?"boolean":"string"}function wn(e,t){const n=e.filter(s=>s!=null&&s!==""),r=e.length-n.length,a=new Set(n).size;if(t==="number"){const s=n.map(i=>Number(i)).filter(i=>!isNaN(i));return{count:e.length,mean:J(s),median:bn(s),mode:Ke(s),stdDev:En(s),min:Math.min(...s),max:Math.max(...s),q1:xe(s,25),q2:xe(s,50),q3:xe(s,75),nullCount:r,uniqueCount:a}}return{count:e.length,mode:Ke(n),min:n[0],max:n[n.length-1],nullCount:r,uniqueCount:a}}function J(e){return e.length===0?0:e.reduce((t,n)=>t+n,0)/e.length}function bn(e){if(e.length===0)return 0;const t=[...e].sort((r,a)=>r-a),n=Math.floor(t.length/2);return t.length%2===0?(t[n-1]+t[n])/2:t[n]}function Ke(e){if(e.length===0)return null;const t={};let n=0,r=null;for(const a of e){const s=String(a);t[s]=(t[s]||0)+1,t[s]>n&&(n=t[s],r=a)}return r}function En(e){if(e.length===0)return 0;const t=J(e),n=e.map(r=>Math.pow(r-t,2));return Math.sqrt(J(n))}function xe(e,t){if(e.length===0)return 0;const n=[...e].sort((c,o)=>c-o),r=t/100*(n.length-1),a=Math.floor(r),s=Math.ceil(r),i=r%1;return a===s?n[a]:n[a]*(1-i)+n[s]*i}function Sn(e){if(e.length<4)return{indices:[],threshold:0};const t=xe(e,25),n=xe(e,75),r=n-t,a=t-1.5*r,s=n+1.5*r,i=[];return e.forEach((c,o)=>{(c<a||c>s)&&i.push(o)}),{indices:i,threshold:r}}function Rn(e,t){if(e.length!==t.length||e.length===0)return 0;const n=e.length,r=J(e),a=J(t);let s=0,i=0,c=0;for(let o=0;o<n;o++){const u=e[o]-r,d=t[o]-a;s+=u*d,i+=u*u,c+=d*d}return i===0||c===0?0:s/Math.sqrt(i*c)}function On(e){if(e.length<2)return{direction:"stable",strength:0};const t=e.length,n=Array.from({length:t},(u,d)=>d),r=J(n),a=J(e);let s=0,i=0;for(let u=0;u<t;u++)s+=(n[u]-r)*(e[u]-a),i+=Math.pow(n[u]-r,2);const c=i===0?0:s/i,o=Math.min(Math.abs(c)/(J(e)||1),1);return Math.abs(c)<.01?{direction:"stable",strength:0}:{direction:c>0?"up":"down",strength:o}}async function jn(e,t,n,r){console.log(`Starting analysis for dataset ${e}`);for(const s of n){const i=t.map(d=>d[s.name]),c=wn(i,s.type),o=Cn(s.name,s.type,c),u=Tn(c,s.type);if(await r.prepare(`
      INSERT INTO analyses (dataset_id, analysis_type, column_name, result, confidence, explanation, importance)
      VALUES (?, ?, ?, ?, ?, ?, ?)
    `).bind(e,"statistics",s.name,JSON.stringify(c),1,o,u).run(),s.type==="number"){const d=i.map(f=>Number(f)).filter(f=>!isNaN(f)),h=Sn(d);if(h.indices.length>0){const f=`Found ${h.indices.length} unusual values in "${s.name}" (${(h.indices.length/d.length*100).toFixed(1)}% of data). These values are significantly different from the rest and might need attention.`;await r.prepare(`
          INSERT INTO analyses (dataset_id, analysis_type, column_name, result, confidence, explanation, importance)
          VALUES (?, ?, ?, ?, ?, ?, ?)
        `).bind(e,"outlier",s.name,JSON.stringify({count:h.indices.length,indices:h.indices.slice(0,10)}),.85,f,h.indices.length>d.length*.05?"high":"medium").run()}if(d.length>5){const f=On(d);if(f.direction!=="stable"){const v=`"${s.name}" shows a ${f.direction==="up"?"rising":"falling"} trend with ${(f.strength*100).toFixed(0)}% strength. This ${f.direction==="up"?"increase":"decrease"} is consistent across the dataset.`;await r.prepare(`
            INSERT INTO analyses (dataset_id, analysis_type, column_name, result, confidence, explanation, importance)
            VALUES (?, ?, ?, ?, ?, ?, ?)
          `).bind(e,"trend",s.name,JSON.stringify(f),f.strength,v,f.strength>.5?"high":"medium").run()}}}}const a=n.filter(s=>s.type==="number");for(let s=0;s<a.length;s++)for(let i=s+1;i<a.length;i++){const c=a[s],o=a[i],u=t.map(h=>Number(h[c.name])).filter(h=>!isNaN(h)),d=t.map(h=>Number(h[o.name])).filter(h=>!isNaN(h));if(u.length>5&&d.length>5){const h=Rn(u,d);if(Math.abs(h)>.5){const f=Nn(c.name,o.name,h);await r.prepare(`
            INSERT INTO analyses (dataset_id, analysis_type, column_name, result, confidence, explanation, importance)
            VALUES (?, ?, ?, ?, ?, ?, ?)
          `).bind(e,"correlation",`${c.name}_vs_${o.name}`,JSON.stringify({column1:c.name,column2:o.name,correlation:h}),Math.abs(h),f,Math.abs(h)>.7?"high":"medium").run()}}}for(const s of n)if(s.type==="string"){const i=t.map(d=>d[s.name]).filter(d=>d),c={};i.forEach(d=>{c[d]=(c[d]||0)+1});const u=Object.entries(c).sort((d,h)=>h[1]-d[1]).slice(0,5);if(u.length>0&&u[0][1]>i.length*.1){const d=`The most common value in "${s.name}" is "${u[0][0]}" appearing ${u[0][1]} times (${(u[0][1]/i.length*100).toFixed(1)}% of records).`;await r.prepare(`
          INSERT INTO analyses (dataset_id, analysis_type, column_name, result, confidence, explanation, importance)
          VALUES (?, ?, ?, ?, ?, ?, ?)
        `).bind(e,"pattern",s.name,JSON.stringify({topPatterns:u}),.9,d,"medium").run()}}console.log(`Analysis complete for dataset ${e}`)}function Cn(e,t,n){var r,a,s,i;return t==="number"?`"${e}" ranges from ${(r=n.min)==null?void 0:r.toFixed(2)} to ${(a=n.max)==null?void 0:a.toFixed(2)} with an average of ${(s=n.mean)==null?void 0:s.toFixed(2)}. About half the values are below ${(i=n.median)==null?void 0:i.toFixed(2)}.`:`"${e}" contains ${n.count} values with ${n.uniqueCount} unique entries. Most common: "${n.mode}".`}function Nn(e,t,n){const r=Math.abs(n)>.7?"strong":"moderate";return n>0?`There's a ${r} relationship between "${e}" and "${t}": when ${e} increases, ${t} tends to increase too (correlation: ${n.toFixed(2)}).`:`There's a ${r} inverse relationship between "${e}" and "${t}": when ${e} increases, ${t} tends to decrease (correlation: ${n.toFixed(2)}).`}function Tn(e,t){return e.nullCount>e.count*.5?"high":e.uniqueCount===1?"low":t==="number"&&e.stdDev>e.mean?"high":"medium"}const St=new Ae;St.post("/",async e=>{try{const n=(await e.req.formData()).get("file");if(!n)return e.json({error:"No file provided"},400);const r=n.name,a=r.endsWith(".csv")?"csv":r.endsWith(".json")?"json":null;if(!a)return e.json({error:"Unsupported file type. Please upload CSV or JSON."},400);const s=await n.text();let i;if(a==="csv")i=xn(s);else try{const h=JSON.parse(s);i=Array.isArray(h)?h:[h]}catch{return e.json({error:"Invalid JSON format"},400)}if(i.length===0)return e.json({error:"File contains no data"},400);const c=yn(i),o=Object.keys(i[0]).map(h=>({name:h,type:c[h]||"string",nullable:i.some(f=>f[h]===null||f[h]===void 0||f[h]===""),unique_count:new Set(i.map(f=>f[h])).size,sample_values:i.slice(0,3).map(f=>f[h])})),d=(await e.env.DB.prepare(`
      INSERT INTO datasets (name, original_filename, file_type, row_count, column_count, columns, analysis_status)
      VALUES (?, ?, ?, ?, ?, ?, ?)
    `).bind(r.replace(/\.[^.]+$/,""),r,a,i.length,o.length,JSON.stringify(o),"analyzing").run()).meta.last_row_id;for(let h=0;h<i.length;h++)await e.env.DB.prepare(`
        INSERT INTO data_rows (dataset_id, row_number, data, is_cleaned)
        VALUES (?, ?, ?, ?)
      `).bind(d,h,JSON.stringify(i[h]),0).run();return jn(d,i,o,e.env.DB).then(async()=>{await e.env.DB.prepare(`
          UPDATE datasets SET analysis_status = ?, cleaning_status = ?, visualization_status = ?
          WHERE id = ?
        `).bind("complete","complete","complete",d).run()}).catch(async h=>{console.error("Analysis error:",h),await e.env.DB.prepare(`
          UPDATE datasets SET analysis_status = ?
          WHERE id = ?
        `).bind("error",d).run()}),e.json({success:!0,dataset_id:d,message:"Upload successful. Analysis started.",row_count:i.length,column_count:o.length,columns:o})}catch(t){return console.error("Upload error:",t),e.json({error:"Upload failed: "+t.message},500)}});const de=new Ae;de.get("/",async e=>{try{const n=(await e.env.DB.prepare(`
      SELECT * FROM datasets ORDER BY upload_date DESC
    `).all()).results.map(r=>({...r,columns:JSON.parse(r.columns)}));return e.json({datasets:n})}catch{return e.json({error:"Failed to fetch datasets"},500)}});de.get("/:id",async e=>{try{const t=e.req.param("id"),n=await e.env.DB.prepare(`
      SELECT * FROM datasets WHERE id = ?
    `).bind(t).first();if(!n)return e.json({error:"Dataset not found"},404);const a=(await e.env.DB.prepare(`
      SELECT data FROM data_rows WHERE dataset_id = ? AND is_cleaned = 0 LIMIT 10
    `).bind(t).all()).results.map(s=>JSON.parse(s.data));return e.json({dataset:{...n,columns:JSON.parse(n.columns)},sample:a})}catch{return e.json({error:"Failed to fetch dataset"},500)}});de.get("/:id/analyses",async e=>{try{const t=e.req.param("id"),r=(await e.env.DB.prepare(`
      SELECT * FROM analyses WHERE dataset_id = ? ORDER BY importance DESC, confidence DESC
    `).bind(t).all()).results.map(a=>({...a,result:JSON.parse(a.result)}));return e.json({analyses:r})}catch{return e.json({error:"Failed to fetch analyses"},500)}});de.get("/:id/visualizations",async e=>{try{const t=e.req.param("id"),r=(await e.env.DB.prepare(`
      SELECT * FROM visualizations WHERE dataset_id = ? ORDER BY display_order
    `).bind(t).all()).results.map(a=>({...a,config:JSON.parse(a.config)}));return e.json({visualizations:r})}catch{return e.json({error:"Failed to fetch visualizations"},500)}});de.delete("/:id",async e=>{try{const t=e.req.param("id");return await e.env.DB.prepare(`
      DELETE FROM datasets WHERE id = ?
    `).bind(t).run(),e.json({success:!0,message:"Dataset deleted"})}catch{return e.json({error:"Failed to delete dataset"},500)}});const ee=new Ae;ee.use("/api/*",an());ee.use("/static/*",gn({root:"./public"}));ee.route("/api/upload",St);ee.route("/api/datasets",de);ee.get("/api/health",e=>e.json({status:"ok",timestamp:new Date().toISOString()}));ee.get("/",e=>e.html(`
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Data Intelligence Platform</title>
        <script src="https://cdn.tailwindcss.com"><\/script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"><\/script>
        <style>
          .upload-area {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s;
          }
          .upload-area.drag-over {
            border-color: #3b82f6;
            background-color: #eff6ff;
          }
          .insight-card {
            animation: slideIn 0.5s ease-out;
          }
          @keyframes slideIn {
            from {
              opacity: 0;
              transform: translateY(20px);
            }
            to {
              opacity: 1;
              transform: translateY(0);
            }
          }
          .importance-high { border-left: 4px solid #ef4444; }
          .importance-medium { border-left: 4px solid #f59e0b; }
          .importance-low { border-left: 4px solid #10b981; }
        </style>
    </head>
    <body class="bg-gray-50">
        <div class="min-h-screen">
            <!-- Header -->
            <header class="bg-white shadow-sm border-b">
                <div class="max-w-7xl mx-auto px-4 py-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900">
                                <i class="fas fa-brain text-blue-600 mr-3"></i>
                                Data Intelligence Platform
                            </h1>
                            <p class="text-gray-600 mt-1">Upload → Analyze → Understand. Automated insights from your data.</p>
                        </div>
                        <button id="view-datasets" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition">
                            <i class="fas fa-database mr-2"></i>My Datasets
                        </button>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="max-w-7xl mx-auto px-4 py-8">
                <!-- Upload Section -->
                <div id="upload-section" class="mb-8">
                    <div class="bg-white rounded-xl shadow-lg p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-upload mr-2 text-blue-600"></i>
                            Upload Your Data
                        </h2>
                        <p class="text-gray-600 mb-6">
                            Drop a CSV or JSON file below and we'll automatically analyze it, find patterns, 
                            and explain what matters in plain English.
                        </p>

                        <div id="upload-area" class="upload-area rounded-lg p-12 text-center cursor-pointer">
                            <input type="file" id="file-input" accept=".csv,.json" class="hidden">
                            <div id="upload-prompt">
                                <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
                                <p class="text-xl text-gray-700 mb-2">Drop your file here or click to browse</p>
                                <p class="text-sm text-gray-500">Supports CSV and JSON files</p>
                            </div>
                            <div id="upload-progress" class="hidden">
                                <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
                                <p class="text-lg text-gray-700">Uploading and analyzing...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="results-section" class="hidden">
                    <!-- Dataset Info -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-info-circle mr-2 text-blue-600"></i>
                            Dataset Overview
                        </h2>
                        <div id="dataset-info" class="grid grid-cols-1 md:grid-cols-4 gap-4"></div>
                    </div>

                    <!-- Key Insights -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>
                            Key Insights
                        </h2>
                        <div id="insights-container" class="space-y-4"></div>
                    </div>

                    <!-- Sample Data -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-table mr-2 text-green-600"></i>
                            Sample Data
                        </h2>
                        <div id="sample-data" class="overflow-x-auto"></div>
                    </div>
                </div>

                <!-- Datasets List -->
                <div id="datasets-section" class="hidden">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">
                                <i class="fas fa-database mr-2 text-blue-600"></i>
                                Your Datasets
                            </h2>
                            <button id="back-to-upload" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                <i class="fas fa-plus mr-2"></i>New Upload
                            </button>
                        </div>
                        <div id="datasets-list"></div>
                    </div>
                </div>
            </main>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"><\/script>
        <script src="/static/app.js"><\/script>
    </body>
    </html>
  `));const Ye=new Ae,_n=Object.assign({"/src/index.tsx":ee});let Rt=!1;for(const[,e]of Object.entries(_n))e&&(Ye.all("*",t=>{let n;try{n=t.executionCtx}catch{}return e.fetch(t.req.raw,t.env,n)}),Ye.notFound(t=>{let n;try{n=t.executionCtx}catch{}return e.fetch(t.req.raw,t.env,n)}),Rt=!0);if(!Rt)throw new Error("Can't import modules from ['/src/index.ts','/src/index.tsx','/app/server.ts']");export{Ye as default};
